<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUTI - Music User Type Indicator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .full-width-container { grid-column: 1 / -1; margin-top: 20px; }
        h1, h2 { color: #4CAF50; }
        h2 { border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
        h3 { color: #333; }
        form div { margin-bottom: 10px; }
        label { display: inline-block; width: 100px; }
        input[type="text"], input[type="email"], input[type="password"] { width: 200px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 18px; background-color: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 4px; margin-right: 5px; font-size: 14px; }
        button:hover { background-color: #45a049; }
        .response-div { margin-top: 15px; padding: 12px; border: 1px solid #ccc; background-color: #f9f9f9; white-space: pre-wrap; min-height: 40px; border-radius: 4px; }
        ul { list-style-type: none; padding: 0; }
        li { background: #f0f0f0; margin: 5px 0; padding: 10px; border-radius: 4px; }
        #surveyFormContainer .question { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        #surveyFormContainer h3 { margin-bottom: 15px; }
        .likert-scale { display: flex; justify-content: space-around; align-items: center; }
        .likert-label { display: flex; flex-direction: column; align-items: center; cursor: pointer; font-size: 13px; }
        .likert-label input { margin-bottom: 5px; }
    </style>
</head>
<body>

    <h1>MUTI - 당신의 음악 성향을 알아보세요!</h1>

    <div class="container full-width-container">
        <h2>MUTI 검사 및 음악 추천</h2>
        <button id="startSurveyButton">성향 검사 시작하기</button>
        <div id="surveyFormContainer"></div>
        <div id="printableResultArea">
            <div id="surveyResult" class="response-div" style="display:none;"></div>
            <div id="recommendationContainer" class="full-width-container" style="display:none; margin-top: 20px;">
                <h3>당신을 위한 추천 음악</h3>
                <ul id="recommendationsList"></ul>
            </div>
        </div>
    </div>

    <script>
        let jwtToken = null;

        // --- Page Load & Auth Check ---
        window.addEventListener('load', () => {
            jwtToken = sessionStorage.getItem('jwt');
            if (!jwtToken) {
                alert("로그인이 필요합니다.");
                window.location.href = '/index.html';
                return;
            }
            // This part is for Kakao login redirect, but the token is now handled on the login page.
            // It can be removed or kept for other potential token-in-URL scenarios.
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromUrl = urlParams.get('token');
            if (tokenFromUrl) {
                jwtToken = tokenFromUrl;
                sessionStorage.setItem('jwt', jwtToken);
                window.history.replaceState({}, document.title, "/survey.html");
            }
        });

        // --- API Helper ---
        async function apiFetch(url, options = {}) {
            const token = sessionStorage.getItem('jwt');
            if (!token) {
                alert('로그인 세션이 만료되었습니다. 다시 로그인해주세요.');
                window.location.href = '/index.html';
                return { error: true, message: 'Not logged in' };
            }
            const defaultHeaders = { 
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            };
            try {
                return await fetch(url, { ...options, headers: { ...defaultHeaders, ...options.headers } });
            } catch (error) {
                return { error: true, message: `Network Error: ${error.message}` };
            }
        }

        // --- Registration (No longer needed on this page) ---
        
        // --- Login (No longer needed on this page) ---

        // --- 3. MUTI Survey ---
        document.getElementById('startSurveyButton').addEventListener('click', async function() {
            const surveyContainer = document.getElementById('surveyFormContainer');
            surveyContainer.innerHTML = '질문을 불러오는 중...';
            const response = await apiFetch('/api/survey/questions');
            if (response && response.ok) {
                const questions = await response.json();
                let formHtml = '<form id="surveyForm">';
                questions.forEach(q => {
                    formHtml += `<div class="question"><h3>${q.text}</h3>`;
                    q.choices.forEach(c => { formHtml += `<div><input type="radio" name="question_${q.id}" value="${c.id}" required><label>${c.text}</label></div>`; });
                    formHtml += '</div>';
                });
                formHtml += '<button type="submit">결과 확인하기</button></form>';
                surveyContainer.innerHTML = formHtml;
                document.getElementById('surveyForm').addEventListener('submit', submitSurvey);
            } else { surveyContainer.innerHTML = '질문을 불러오는데 실패했습니다. 로그인 상태를 확인해주세요.'; }
        });

        async function submitSurvey(event) {
            event.preventDefault();
            const answers = {};
            const formData = new FormData(event.target);
            for (let [key, value] of formData.entries()) { answers[key.split('_')[1]] = Number(value); }

            const response = await apiFetch('/api/survey/submit', { method: 'POST', body: JSON.stringify({ answers }) });
            
            if (response && response.ok) {
                const result = await response.json();
                // 결과를 sessionStorage에 저장하고 결과 페이지로 리디렉션
                sessionStorage.setItem('mutiResult', JSON.stringify(result));
                window.location.href = 'result.html';
            } else { 
                const resultDiv = document.getElementById('surveyResult');
                resultDiv.textContent = '결과를 제출하는데 실패했습니다.'; 
                resultDiv.style.display = 'block'; 
            }
        }

        // This page no longer needs recommendation/PDF logic as it's on result.html
    </script>
</body>
</html>